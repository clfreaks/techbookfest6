# エディタ「Lem」

**Lem**はほぼ全ての機能がCommon Lispにより実装されているエディタです。
単なるエディタにとどまらず、Common Lispの開発環境一式を提供しています。また、Lem自体がCommon Lispにより拡張可能です。

本書の執筆陣の過半数がCommon Lispでの開発に主にLemを使用している実績からいって、ことCommon Lispの開発にかけては必要十分な機能を提供できていると思われます。
また、まだ数は少ないものの、Common Lisp以外の言語のコード編集もサポートしています。
操作体系はEmacsと似たものになっていますが、vi(Vim)モードも用意されており、設定により切り替えて使えるようになっています。

本章では、3章以降で必要とされるLemの基本操作、Common Lisp開発に関連した機能に絞って紹介します。
Lemの用語や拡張機能の実装方法などの、より詳細な解説については7章を参照してください。

## Lemのインストール

Lemは以下のようにRoswellからインストールできます。Roswellについては1章を参照してください。

```
$ ros install cxxxr/lem
```

Lemは256色をサポートしたターミナル上で使うことを想定しています。
Linuxのターミナルの場合、デフォルトでは8色しか表示できない事が多いので、`TERM`環境変数で明示的に256色を指定しておきます。

```
$ export TERM=xterm-256color
```

## キーバインドの表記について

LemではEmacsと同じように`Control`や`Meta`をプリフィクスとするコマンドを使用します。これらは次のように表記されます。

- `C-` : `Control`キーを押しながら別のキーを打つことを意味します。
- `M-` : `Meta`キーを押しながら別のキーを打つことを意味します。Metaキーには通常Altキーが割り当てられています。macOSのターミナルでは設定でOptionキーに割り当てることができます。

例えば、

- `C-o`は`Control`を押しながら`o`を押すことを意味します。
- `C-x o`は `Control`を押しながら`x`を押した後、一度`Control`を離して、単独で`o`を押すことを意味します。
- `C-x C-o`は`Control`を押しながら`x`を押し、さらに続けて`Control`を押しながら`o`を押すことを意味します。

`M-x`は少し特殊で、`M-x`を入力した時点でプロンプトが現われ、続いてコマンドを入力し、`Return`で確定します(コマンド名は途中まで入力した状態で`Tab`を押すことで補完できます)。これは例えば`M-x describe-bindings`のように表記されます。

## Lemの基本的な使い方

### 起動と終了

コマンドラインからLemを起動するには`lem`コマンドを使用します。
1章で解説したように、LemをRoswellからインストールした場合、`~/.roswell/bin`以下にLemの実行可能ファイルができます。
`PATH`環境変数にこのディレクトリを含むように設定しておくと、以下のようにLemを起動できます。

```
$ lem

# 開くファイルを指定して起動する場合
$ lem [ファイル名]
```
初回起動時にはLemのビルドを行うので多少時間がかかります。次回以降は一瞬で起動するようになります。

Lemを終了するには`C-x C-c`と入力してください。

### ファイルの編集と保存

Lemを起動したらファイルを開いてみましょう。
`C-x C-f`と入力すると、画面中央にパスを入力する領域(これを**ミニバッファ**と呼びます)が表示され、ファイルのパスを入力して`Return`を押すことでファイルを開くことができます。
この入力画面で`Tab`を押すと補完が働き、既存のディレクトリやファイルから選択できます。また、存在しないファイル名を入力すると新規にファイルが作られます。

編集が終わったら`C-x C-s`で編集内容を保存できます。
<!-- 編集のキーとしてはundo`C-\\`とredo`C-_`の操作は特殊なので覚えておきましょう。 (ここで書くことではない、後のコマンド表に書いておけばいい) -->

### 複数のファイルの編集

`C-x C-f`でファイルを開いた後に、さらに`C-x C-f`で別のファイルを開くことができます。
このとき、画面には後から開いたファイルの内容が表示されますが、先に開いていたファイルは隠されているだけで、裏ではファイルの内容が保持されています。
ファイルの内容を保持しているもののことを**バッファ**と呼びます。

複数ファイルを開いている時に、`C-x b`を押すと、ミニバッファに`Use Buffer:`というプロンプトが出てきます。
ここにファイル名を入力し`Return`で確定すると、編集するファイルを切り替えられます。
ファイル名(正確にはバッファ名)を全てキーボードで入力するのは面倒ですが、ここでも`Tab`を押すことで補完が働き、現在存在しているバッファが候補として表示されます。補完候補は`↑`、`↓`で選択するか、候補文字列の一部をさらに入力することで対象を絞り込めます。

編集を終え、ファイルを閉じる(バッファを削除する)には`C-x k`を使います。このとき`C-x C-s`で保存されていない内容は破棄されるので注意してください。

### 画面の分割

Lemでは画面領域を分割することができます。
現在の画面を上下に2分割するには`C-x 2`、左右に2分割するには`C-x 3`を入力します。

画面を分割すると、分割前の画面で開いていたファイルがそれぞれの画面に表示されています。`C-x C-f`でファイルを開いたり、`C-x b`でバッファを切り替えましょう。
編集中の画面(カーソルがある画面)を別の画面に切り替えるには`M-o`を使います。

分割を解除して1つの画面領域にしたいときは、`C-x 0`で現在の画面、`C-x 1`で現在の画面以外を消すことができます。

### SLIME

**SLIME** は The Superior Lisp Interaction Mode for Emacs の略で、元々はEmacs用のCommon Lisp開発用パッケージです。
LemにはこのSLIMEをほぼ再現したものが標準で組込まれており、インストールした時点からCommon Lisp開発のための機能が全て利用できます。

SLIMEを起動するにはLem上で、`M-x slime`と入力します。これにより画面が分割され、`CL-USER>`というプロンプトが表示されている画面が現われます。
この画面はREPLと呼ばれ、Lisp式を入力するとその評価結果を返す機能を持っています。

`10`のような数値を入力してreturnすると結果として`10`が返ります。
`(+ 2 (* 3 4) 5)`のような少し複雑な式を入力すると`19`のようにきちっと計算しているのがわかります。

コマンドプロンプトと同様replでも同じ式を何度も打ち込んだり、過去に打った式を編集してもう一度打ち込みたい時の為に履歴を参照することができます。普通のコマンドプロンプトでは履歴の参照は`↑`,`↓`キーで行ないますが、lemのreplではカーソルが動いてしまいます。履歴の参照は`↑`にあたるのが`M-p`,`↓`にあたるのが`M-n`です。

replの画面はちょっとした式の入力(たとえば`(loop for i to 100000 collect i)` など)で簡単に画面を埋めつくしてしまうことがあるため、消去したくなることがあります。`C-c M-o` と入力すると散らかった画面を消すことができます。また、間違って決して終了しない式を入力してしまった際(たとえば、`(loop while t :do (sleep 0))`)に、 `C-c C-c`を押すと式の実行を強制終了することができます。デバッガが立ち上がりますが、`q`で終了させることができます。


### lispファイルを編集中のキー操作
`C-x C-f`で拡張子が`.lisp`のファイルを開くとlisp用のキーがいくつか使えるようになります。ここでは便利なものを紹介します。

//embed[latex]{
\vspace{1\Cvs}
//}

//table{
キー	操作
------------
`C-c C-e`	直前の式を評価する。
`C-M-q`	直後の式をインデントする。　　　　　　　　　　　　　　　　　　　　
`C-c z`	画面をreplに切り替える
//}

//embed[latex]{
\vspace{1\Cvs}
//}

### キー操作で困ったときは
ここまでで学んだことは必要最小限の内容なので、何かのはずみで本章で説明していない状態になってキー操作ができないと感じるようなことがあるかもしれません。そういう場合には、とりあえず`C-g`を何回か押すと復帰できるので覚えておくと良いでしょう。全て保証できるわけではありませんが…

//embed[latex]{
\clearpage
//}

### 本章で取り扱ったキー操作

本章で取り扱ったキー操作は次の通りです。

//embed[latex]{
\vspace{1\Cvs}
//}

//table{
キー	操作
------------
`C-x C-c`	Lemの終了
`C-x C-f`	ファイルを開く
`C-\\`	undo(やりなおし)
`C-_`	redo(やりなおしのやりなおし)
`C-x C-f`	ファイルを開く
`C-x C-s`	変更の保存
`C-x b`	編集対象の切り替え
`C-x k`	編集の終了
`C-x 0`	現在の画面の削除
`C-x 1`	現在の画面以外を削除
`C-x 2`	現在の画面を上下ふたつに分割
`C-x 3`	現在の画面を左右ふたつに分割　　　　　　　　　　　　　　　　　　
`M-o`	画面の移動
`C-g`	中断
//}

//embed[latex]{
\vspace{1\Cvs}
//}

###  便利なキー操作

最小限ではないけれど、編集のために便利なキーを紹介します。

//embed[latex]{
\vspace{1\Cvs}
//}

//table{
キー	操作
------------
`C-b`	前の文字へ移動
`C-f`	次の文字へ移動
`C-p`	前の行へ移動
`C-n`	次の行へ移動
`M-C-b`	前の式へ移動
`M-C-f`	次の式へ移動
`M-C-u`	式の外へ移動(直前の`(`へ移動)
`M-C-d`	式の中へ移動(直後の`)`の次へ移動)
`C-h`	直前の文字削除
`C-d`	現在位置の文字削除
`C-k`	行の削除
`C-Space`	選択の開始
`C-w`	選択の開始した位置から現在のカーソル位置までのカット
`M-w`	選択の開始した位置から現在のカーソル位置までのコピー　　　　　
`M-y`	ペースト
//}
